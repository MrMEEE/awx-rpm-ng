#!/bin/bash

if [[ "$1" != "force" ]]; then
        NEWVERSION=$2
        FROMVERSION=$1
else
	NEWVERSION=$3
	FROMVERSION=$2
fi

cd /opt/$BASEPATH_DIR/versions/

if [ -z "$FROMVERSION" ]; then
	echo "Existing version not defined"
	echo "Select from:"
	echo
	cd /opt/$BASEPATH_DIR/versions/
        git branch -rv |cut -f2- -d\/
        exit 1
fi

if [[ `git branch -rv |cut -f2- -d\/ |grep $FROMVERSION | wc -l` -gt 0 ]]; then
        git checkout $FROMVERSION
else
        echo "Source version $FROMVERSION doesn't exists"
        exit 1
fi

if [ -z "$NEWVERSION" ]; then
        echo "Please provide New AWX version"
        echo "Select from"
	echo
        cd /opt/$BASEPATH_DIR/awx/
        git ls-remote --tags origin | cut -f3- -d\/ |grep -v "{}" |sort -Vr
	#git branch -rv |cut -f2- -d\/
        exit 1
fi

if [[ "`cd /opt/$BASEPATH_DIR/awx/ && git ls-remote --tags origin | cut -f3- -d\/ |grep -v "{}" | grep -x $NEWVERSION |wc -l`" != "1" ]]; then
	echo "Version: $NEWVERSION doesn't exist"
	exit 1
fi

rm -rf /opt/$BASEPATH_DIR/migration
mkdir -p /opt/$BASEPATH_DIR/migration/{source,orig,conf,patch,awx-rpm}
cp -ar /opt/$BASEPATH_DIR/versions/deps/extra-sources /opt/$BASEPATH_DIR/migration
mkdir -p /opt/$BASEPATH_DIR/rpmbuilds/$NEWVERSION/SOURCES/
cp /opt/$BASEPATH_DIR/versions/deps/extra-sources/* /opt/$BASEPATH_DIR/rpmbuilds/$NEWVERSION/SOURCES/
cp /opt/$BASEPATH_DIR/versions/PYTHON /opt/$BASEPATH_DIR/migration/
if [ -d /opt/$BASEPATH_DIR/versions/awx-rpm ]; then
	for i in `ls /opt/$BASEPATH_DIR/versions/awx-rpm/*-$FROMVERSION | xargs -n 1 basename`;do
		FILENAME=$(echo $i | sed "s/-$FROMVERSION/-$NEWVERSION/g")
		cp /opt/$BASEPATH_DIR/versions/awx-rpm/$i /opt/$BASEPATH_DIR/migration/awx-rpm/$FILENAME
	done
fi

cp -a /opt/$BASEPATH_DIR/versions/deps/*.spec /opt/$BASEPATH_DIR/migration/source/
rm -f /opt/$BASEPATH_DIR/migration/source/awx*
for i in `ls /opt/$BASEPATH_DIR/migration/source/`;do
	if [ -f /opt/$BASEPATH_DIR/versions/deps/original/$i ];then
		cp /opt/$BASEPATH_DIR/versions/deps/original/$i /opt/$BASEPATH_DIR/migration/orig/
	else
		cp /opt/$BASEPATH_DIR/migration/source/$i /opt/$BASEPATH_DIR/migration/orig/
	fi
done
cp -a /opt/$BASEPATH_DIR/versions/deps/*.conf /opt/$BASEPATH_DIR/migration/conf/

cd /opt/$BASEPATH_DIR/migration/

for i in `ls /opt/$BASEPATH_DIR/migration/source/`;do

	NAME=$(echo $i |cut -f1 -d.)
	diff --ignore-all-space -uNr orig/$i source/$i > /opt/$BASEPATH_DIR/migration/patch/$NAME.patch

done

find /opt/$BASEPATH_DIR/migration/patch/ -type f -empty -delete

cp /opt/$BASEPATH_DIR/versions/deps/{extra-deps.txt,remove-deps.txt,rhel-deps.txt} /opt/$BASEPATH_DIR/migration/

cd /opt/$BASEPATH_DIR/versions/

git switch --orphan $NEWVERSION

touch /opt/$BASEPATH_DIR/versions/VERSION-$NEWVERSION

git add /opt/$BASEPATH_DIR/versions/VERSION-$NEWVERSION

git commit -qam "Created Version $NEWVERSION"

git push -u origin $NEWVERSION

/opt/$BASEPATH_DIR/scripts/changeversion $NEWVERSION

/opt/$BASEPATH_DIR/scripts/pypi2spec
for i in `cat /opt/$BASEPATH_DIR/migration/extra-deps.txt`; do

	PACKAGENAME=$(echo $i | cut -f1 -d=)
	VERSION=$(echo $i | cut -f3 -d=)
	
	echo "Adding package $PACKAGENAME $VERSION"
	if [[ "$PACKAGENAME" == "$VERSION" ]];then
		/opt/$BASEPATH_DIR/scripts/addpackage $PACKAGENAME nobuild
	else 
		/opt/$BASEPATH_DIR/scripts/addpackage $PACKAGENAME $VERSION nobuild
	fi

done

cp /opt/$BASEPATH_DIR/migration/remove-deps.txt /opt/$BASEPATH_DIR/versions/deps/remove-deps.txt
cp /opt/$BASEPATH_DIR/migration/rhel-deps.txt /opt/$BASEPATH_DIR/versions/deps/rhel-deps.txt
cp -ar /opt/$BASEPATH_DIR/migration/extra-sources /opt/$BASEPATH_DIR/versions/deps/
cp /opt/$BASEPATH_DIR/migration/PYTHON /opt/$BASEPATH_DIR/versions/PYTHON
mkdir -p /opt/$BASEPATH_DIR/versions/awx-rpm
cp /opt/$BASEPATH_DIR/migration/awx-rpm/* /opt/$BASEPATH_DIR/versions/awx-rpm/

for i in `cat /opt/$BASEPATH_DIR/migration/remove-deps.txt /opt/$BASEPATH_DIR/migration/rhel-deps.txt`; do
	PACKAGENAME=$(echo $i | sed "s/python//g" | sed "s/python3//g")
	echo "Removing package $PACKAGENAME"
	rm -f /opt/$BASEPATH_DIR/versions/deps/*$PACKAGENAME.spec
	rm -f /opt/$BASEPATH_DIR/versions/deps/*$PACKAGENAME.conf
	rm -f /opt/$BASEPATH_DIR/versions/deps/original/*$PACKAGENAME.spec
        rm -f /opt/$BASEPATH_DIR/versions/deps/original/*$PACKAGENAME.conf
done

cd /opt/$BASEPATH_DIR/versions/
git add /opt/$BASEPATH_DIR/versions/*
git commit -qam "Imported from version $FROMVERSION to version $NEWVERSION"
git push

/opt/$BASEPATH_DIR/scripts/getsources

echo "Applying patches from version: $FROMVERSION"

/opt/$BASEPATH_DIR/scripts/applypatches

